#!/bin/bash

# Do some logic to set things up for the proper version.
echo "Building with OpenFOAM-"$WM_PROJECT_VERSION

version=${WM_PROJECT_VERSION:0:1}
variant=${WM_PROJECT_VERSION:2:1}

dir20=2.0-and-lower
dir21=2.1-2.2
dir23=2.3-and-higher

dir=$dir20
if [ $version -lt 2 ]
then
   dir=$dir20
   dirrm1=$dir21
   dirrm2=$dir23
elif [ $version -gt 2 ]
then
   dir=$dir23
   dirrm1=$dir20
   dirrm2=$dir21
elif [ $version -eq 2 ] && [ $variant -le 0 ]
then
   dir=$dir20
   dirrm1=$dir21
   dirrm2=$dir23
elif [ $version -eq 2 ] && [ $variant -ge 1 ] && [ $variant -le 2 ]
then
   dir=$dir21
   dirrm1=$dir20
   dirrm2=$dir23
elif [ $version -eq 2 ] && [ $variant -ge 3 ]
then
   dir=$dir23
   dirrm1=$dir20
   dirrm2=$dir21
fi


# Turbulence models.
cd src/turbulenceModels/incompressible/LES/

cd GenEddyViscABL
rm GenEddyViscABL.H
rm GenEddyViscABL.C
ln -s $dir/GenEddyViscABL.H ./
ln -s $dir/GenEddyViscABL.C ./
rm -rf $dirrm1 $dirrm2
cd ../

cd KosovicOneEqNBA
rm KosovicOneEqNBA.H
rm KosovicOneEqNBA.C
ln -s $dir/KosovicOneEqNBA.H ./
ln -s $dir/KosovicOneEqNBA.C ./
rm -rf $dirrm1 $dirrm2
cd ../

wmake libso
cd ../../../../


# Actuator turbine models.
cd src/turbineModels/turbineModelsStandard
wmake libso
cd ../../../


# FAST 8 coupled turbine models.
if [ -z ${FAST_DIR+x} ]
then
    echo "FAST_DIR is not set. Not compiling FASTv8 interface."
else
    if [ -d ${FAST_DIR} ] 
    then
	echo "FAST_DIR is set to '${FAST_DIR}'. Attempting to compile FASTv8 interface."
	cd src/turbineModels/turbineModelsFASTv8
	wmake libso
	cd ../../../
    else
	echo "FAST_DIR is set to '${FAST_DIR}'. Directory doesn't exist or I can't access it. Skipping compilation of FASTv8 interface."
    fi	
fi

# OpenFAST coupled turbine models.
if [ -z ${OPENFAST_DIR+x} ]
then
    echo "OPENFAST_DIR is not set. Not compiling OpenFAST interface."
else
    if [ -d ${OPENFAST_DIR} ] 
    then
	echo "OPENFAST_DIR is set to '${OPENFAST_DIR}'. Attempting to compile OpenFAST interface."
	cd src/turbineModels/turbineModelsOpenFAST
	wmake libso
	cd ../../../
    else
	echo "FAST_DIR is set to '${FAST_DIR}'. Directory doesn't exist or I can't access it. Skipping compilation of OpenFAST interface."
    fi	
fi

# Custom sampling (this includes sampling on an annulus).
cd src/sampling
wmake libso
cd ../../


# Custom boundary conditions.
cd src/finiteVolume
wmake libso
cd ../../


# Custom function objects (this includes the lidar sampling).
cd src/postProcessing/functionObjects/utilities
wmake libso
cd ../../../../


# Utility to set the initial fields for the ABL solver.
cd applications/utilities/setFieldsABL
wmake
cd ../../../


# The atmospheric LES solver for precursors.
cd applications/solvers/incompressible/windEnergy/ABLSolver
rm pEqn.H
rm ABLSolver.C
rm Make/options
ln -s $dir/pEqn.H ./
ln -s $dir/ABLSolver.C ./
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../


# The atmospheric LES solver for terrain cases.
cd applications/solvers/incompressible/windEnergy/ABLTerrainSolver
rm pEqn.H
rm ABLTerrainSolver.C
rm Make/options
ln -s $dir/pEqn.H ./
ln -s $dir/ABLTerrainSolver.C ./
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../


# The wind plant solver with the standard actuator line.
cd applications/solvers/incompressible/windEnergy/windPlantSolver.ALM
rm pEqn.H
rm windPlantSolver.C
rm Make/options
ln -s $dir/pEqn.H ./
ln -s $dir/windPlantSolver.C ./
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../


# The wind plant solver with the advanced actuator line.
cd applications/solvers/incompressible/windEnergy/windPlantSolver.ALMAdvanced
rm pEqn.H
rm windPlantSolver.C
rm Make/options
ln -s $dir/pEqn.H ./
ln -s $dir/windPlantSolver.C ./
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../


if [ -z ${FAST_DIR+x} ]
then
    echo "FAST_DIR is not set. Not compiling OpenFAST solver."
else
    if [ -d ${FAST_DIR} ] 
    then
	echo "FAST_DIR is set to '${FAST_DIR}'. Attempting to compile FAST windPlant solver."
        # The wind plant solver with the FAST 8 coupled advanced actuator line.
	cd applications/solvers/incompressible/windEnergy/windPlantSolver.ALMAdvancedFASTv8
	rm pEqn.H
	rm windPlantSolver.C
	rm Make/options
	ln -s $dir/pEqn.H ./
	ln -s $dir/windPlantSolver.C ./
	ln -s ../$dir/options ./Make
	rm -rf $dirrm1 $dirrm2
	wmake
	cd ../../../../../
    else
	echo "FAST_DIR is set to '${FAST_DIR}'. Directory doesn't exist or I can't access it. Skipping compilation of OpenFAST solver."
    fi	
fi

if [ -z ${OPENFAST_DIR+x} ]
then
    echo "OPENFAST_DIR is not set. Not compiling OpenFAST solver."
else
    if [ -d ${OPENFAST_DIR} ] 
    then
	echo "OPENFAST_DIR is set to '${OPENFAST_DIR}'. Attempting to compile OpenFAST windPlant solver."
        # The wind plant solver with the OpenFAST coupled advanced actuator line.
	cd applications/solvers/incompressible/windEnergy/windPlantSolver.ALMAdvancedOpenFAST
	rm pEqn.H
	rm windPlantSolver.C
	rm Make/options
	ln -s $dir/pEqn.H ./
	ln -s $dir/windPlantSolver.C ./
	ln -s ../$dir/options ./Make
	rm -rf $dirrm1 $dirrm2
	wmake
	cd ../../../../../
    else
	echo "OPENFAST_DIR is set to '${OPENFAST_DIR}'. Directory doesn't exist or I can't access it. Skipping compilation of OpenFAST solver."
    fi	
fi

# The wind plant solver with the actuator disk.
cd applications/solvers/incompressible/windEnergy/windPlantSolver.ADM
rm pEqn.H
rm windPlantSolver.C
rm Make/options
ln -s $dir/pEqn.H ./
ln -s $dir/windPlantSolver.C ./
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../


# The basic non-buoyant solver with the standard actuator line.
cd applications/solvers/incompressible/windEnergy/pisoFoamTurbine.ALM
rm pisoFoamTurbine.C
rm Make/options
ln -s $dir/pisoFoamTurbine.C
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../


# The basic non-buoyant solver with the advanced actuator line.
cd applications/solvers/incompressible/windEnergy/pisoFoamTurbine.ALMAdvanced
rm pisoFoamTurbine.C
rm Make/options
ln -s $dir/pisoFoamTurbine.C
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../


if [ -z ${FAST_DIR+x} ]
then
    echo "FAST_DIR is not set. Not compiling FASTv8 solver."
else
    if [ -d ${FAST_DIR} ] 
    then
	echo "FAST_DIR is set to '${FAST_DIR}'. Attempting to compile FASTv8 pisoFoam solver."
        # The basic non-buoyant solver with the FAST 8 coupled advanced actuator line.
	cd applications/solvers/incompressible/windEnergy/pisoFoamTurbine.ALMAdvancedFASTv8
	rm pisoFoamTurbine.C
	rm Make/options
	ln -s $dir/pisoFoamTurbine.C
	ln -s ../$dir/options ./Make
	rm -rf $dirrm1 $dirrm2
	wmake
	cd ../../../../../
    else
	echo "FAST_DIR is set to '${FAST_DIR}'. Directory doesn't exist or I can't access it. Skipping compilation of FASTv8 solver."
    fi	
fi

if [ -z ${OPENFAST_DIR+x} ]
then
    echo "OPENFAST_DIR is not set. Not compiling OpenFAST solver."
else
    if [ -d ${OPENFAST_DIR} ] 
    then
	echo "OPENFAST_DIR is set to '${OPENFAST_DIR}'. Attempting to compile OpenFAST pisoFoam solver."
        # The basic non-buoyant solver with the OpenFAST coupled advanced actuator line.
	cd applications/solvers/incompressible/windEnergy/pisoFoamTurbine.ALMAdvancedOpenFAST
	rm pisoFoamTurbine.C
	rm Make/options
	ln -s $dir/pisoFoamTurbine.C
	ln -s ../$dir/options ./Make
	rm -rf $dirrm1 $dirrm2
	wmake
	cd ../../../../../
    else
	echo "OPENFAST_DIR is set to '${OPENFAST_DIR}'. Directory doesn't exist or I can't access it. Skipping compilation of OpenFAST solver."
    fi	
fi


# The basic non-buoyant solver with the actuator disk.
cd applications/solvers/incompressible/windEnergy/pisoFoamTurbine.ADM
rm pisoFoamTurbine.C
rm Make/options
ln -s $dir/pisoFoamTurbine.C
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../


# A simple solver shell meant for testing wind turbine models.
cd applications/solvers/incompressible/windEnergy/turbineTestHarness.ALM
rm Make/options
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../


# A simple solver shell meant for testing wind turbine models.
cd applications/solvers/incompressible/windEnergy/turbineTestHarness.ALMAdvanced
rm Make/options
ln -s ../$dir/options ./Make
rm -rf $dirrm1 $dirrm2
wmake
cd ../../../../../
